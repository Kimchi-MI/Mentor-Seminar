###############  
# Stage 1 — Build  
###############
FROM golang:1.22 AS builder

WORKDIR /src

# ADD — может распаковывать архивы (в отличие от COPY)
ADD source.tar.gz .

# Переменные окружения для сборки
ENV CGO_ENABLED=0

# Команда сборки
RUN go build -o myapp main.go


###############  
# Stage 2 — Runtime  
###############
FROM alpine:3.20

# Устанавливаем другой shell (опционально)
SHELL ["/bin/sh", "-c"]

# Директория приложения
WORKDIR /app

# Копируем бинарник из стадии сборки
COPY --from=builder /src/myapp .

# ONBUILD — выполнится, если кто-то создаёт образ FROM этого 
ONBUILD RUN echo "This base image was extended"

EXPOSE 8080

CMD ["./myapp"]
